<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ransomware Tracker - ThirdEye Intelligence</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-dark px-3">
    <span class="navbar-brand">ThirdEye Intelligence</span>
    <div>
        <a href="/dashboard" class="btn btn-outline-light btn-sm">Back to Dashboard</a>
    </div>
</nav>

<div class="container mt-5">

    <h2 class="mb-4">üõ°Ô∏è Ransomware Tracker - Australia</h2>

    <!-- Form -->
    <form method="POST" class="row g-3 mb-5">
        <div class="col-md-4"><input type="text" name="group_name" class="form-control" placeholder="Ransomware Group" required></div>
        <div class="col-md-4"><input type="text" name="target_org" class="form-control" placeholder="Target Organisation" required></div>
        <div class="col-md-4"><input type="text" name="sector" class="form-control" placeholder="Sector" required></div>
        <div class="col-md-4">
            <select name="status" class="form-select" required>
                <option value="">Select Status</option>
                <option>Advertised on Portal</option>
                <option>Data Published</option>
            </select>
        </div>
        <div class="col-md-4"><input type="date" name="date" class="form-control" required></div>
        <div class="col-md-4"><input type="text" name="tags" class="form-control" placeholder="Tags (comma-separated)"></div>
        <div class="col-md-12 text-end">
            <button type="submit" class="btn btn-primary">Add Incident</button>
        </div>
    </form>

    <!-- Live Search -->
    <input id="searchInput" class="form-control mb-4" placeholder="üîç Search by Ransomware Group or Organisation...">

    <!-- Charts -->
    <h5 class="mt-5">üìä Top Ransomware Groups and Target Sectors</h5>
    <div class="row">
        <div class="col-md-6">
            <canvas id="groupChart" height="200"></canvas>
            <ul class="mt-3">
                {% for name, count in top_groups %}
                    <li>{{ name }}: {{ count }}</li>
                {% endfor %}
            </ul>
        </div>
        <div class="col-md-6">
            <canvas id="sectorChart" height="200"></canvas>
            <ul class="mt-3">
                {% for name, count in top_sectors %}
                    <li>{{ name }}: {{ count }}</li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <!-- Tabs by year -->
    <ul class="nav nav-tabs mt-5" role="tablist">
        {% for year in data_by_year %}
        <li class="nav-item">
            <button class="nav-link {% if loop.first %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#year-{{ year }}">{{ year }}</button>
        </li>
        {% endfor %}
    </ul>

    <div class="tab-content">
        {% for year, items in data_by_year.items() %}
        <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="year-{{ year }}">
            <table class="table table-bordered mt-3">
                <thead>
                    <tr><th>Group</th><th>Organisation</th><th>Sector</th><th>Status</th><th>Date</th><th>Tags</th></tr>
                </thead>
                <tbody>
                    {% for row in items %}
                    <tr>
                        <td>{{ row['group_name'] }}</td>
                        <td>{{ row['target_org'] }}</td>
                        <td>{{ row['sector'] }}</td>
                        <td>{{ row['status'] }}</td>
                        <td>{{ row['date'] }}</td>
                        <td>
                            {% for tag in row['tags'].split(',') %}
                                <span class="badge bg-info text-dark">{{ tag.strip() }}</span>
                            {% endfor %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endfor %}
    </div>
</div>

<script>
const groupChart = new Chart(document.getElementById('groupChart'), {
    type: 'pie',
    data: {
        labels: {{ top_groups | map(attribute=0) | list }},
        datasets: [{ data: {{ top_groups | map(attribute=1) | list }},
            backgroundColor: ['#ff6384','#36a2eb','#ffce56','#2ecc71','#8e44ad','#e67e22','#1abc9c','#34495e','#d35400','#c0392b'] }]
    }
});
const sectorChart = new Chart(document.getElementById('sectorChart'), {
    type: 'pie',
    data: {
        labels: {{ top_sectors | map(attribute=0) | list }},
        datasets: [{ data: {{ top_sectors | map(attribute=1) | list }},
            backgroundColor: ['#3498db','#9b59b6','#e74c3c','#1abc9c','#f1c40f','#e67e22','#2ecc71','#7f8c8d','#2980b9','#c0392b'] }]
    }
});

// Live search
document.getElementById('searchInput').addEventListener('input', function () {
    const query = this.value.toLowerCase();
    document.querySelectorAll('.tab-pane.active table tbody tr').forEach(row => {
        const group = row.cells[0]?.innerText.toLowerCase() || '';
        const org = row.cells[1]?.innerText.toLowerCase() || '';
        const match = group.includes(query) || org.includes(query);
        row.style.display = match ? '' : 'none';
    });
});

document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(btn => {
    btn.addEventListener('shown.bs.tab', () => {
        document.getElementById('searchInput').dispatchEvent(new Event('input'));
    });
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
